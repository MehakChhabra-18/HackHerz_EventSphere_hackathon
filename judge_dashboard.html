<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Judge Panel | My Tasks</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="judge_dashboard.css"> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="dashboard-container">
        <aside class="sidebar">
            <h2 class="logo"><i class="fas fa-gavel"></i> Judge Panel</h2>
            <nav>
                <ul>
                    <li><a href="judge_dashboard.html" class="active" data-section="tasks"><i class="fas fa-star-half-alt"></i> Judging Tasks</a></li>
                    <li><a href="view_submission.html" data-section="completed"><i class="fas fa-check-circle"></i> Complete Reviews</a></li>
                    <li><a href="criteria.html" data-section="criteria"><i class="fas fa-scroll"></i> Judging Criteria</a></li>
                    <li class="logout-link"><a href="login.html"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <header class="dashboard-header">
                <h1>My Judging Tasks</h1>
                <div class="user-profile">
                    <span class="welcome-text">Welcome,</span>
                    <span class="user-name" id="judge-name">Judge Alex</span>
                    <i class="fas fa-user-circle profile-icon"></i>
                </div>
            </header>

            <section class="quick-stats-grid" id="stats-grid-container">
            </section>

            <section class="dashboard-section pending-reviews-section">
                <h2><i class="fas fa-code-branch"></i> Submissions for Review</h2>
                <div class="project-list" id="project-list-container">
                </div>
            </section>
        </main>
    </div>
    
    <script>
        // --- DYNAMIC DATA SOURCE ---
        const JUDGE_DATA = { name: "Judge Alex Smith", avg_score: "4.1/5" }; 

        const ALL_PROJECTS_LIST = [
            { id: "P001", title: "Innovation & Hackathon Collaboration Platform", team: "Team AlphaDevs", event: "Web Dev Hackathon" },
            { id: "P002", title: "Eco-Friendly Shopping Assistant App", team: "The Sustainers", event: "AI/ML Challenge" },
            { id: "P004", title: "Decentralized Voting System", team: "SecureVote", event: "CyberSec CTF" },
            { id: "P003", title: "IoT Smart Farm Monitoring System", team: "AgriTech Wizards", event: "IoT Challenge" },
            { id: "P005", title: "Real-time Language Translator", team: "LinguaTech", event: "AI/ML Challenge" },
            { id: "P006", title: "Quantum Cryptography Simulator", team: "Team Qubit", event: "Advanced Computing" },
        ];
        
        // --- LOCAL STORAGE HELPERS ---
        function getJudgeStatusData() {
            try {
                const data = localStorage.getItem('judgeStatus');
                let status;
                
                if (data) {
                    status = JSON.parse(data);
                    
                    const allProjectIds = ALL_PROJECTS_LIST.map(p => p.id);
                    status.completed = status.completed.filter(id => allProjectIds.includes(id));
                    
                    // Check if initial state needs to be forced (e.g., if LS is empty or contains strange data)
                    if (status.completed.length === 0) {
                       status.completed = ["P003", "P004", "P005"]; // Initial state: 3 completed
                    }

                } else {
                    // Initial status: 3 pending (P001, P002, P006), 3 completed (P003, P004, P005)
                    status = { completed: ["P003", "P004", "P005"] };
                }

                // **LOGIC TO AUTO-UPDATE PENDING LIST**
                const allProjectIds = ALL_PROJECTS_LIST.map(p => p.id);
                status.pending = allProjectIds.filter(id => !status.completed.includes(id));
                
                localStorage.setItem('judgeStatus', JSON.stringify(status));
                return status;
            } catch (e) {
                // Fallback status (3 Completed, 3 Pending)
                return { completed: ["P003", "P004", "P005"], pending: ["P001", "P002", "P006"] };
            }
        }
        
        // --- CORE NAVIGATION FUNCTION ---
        function handleAction(projectId, actionType) {
            let targetPage = '';
            
            if (actionType === 'review' || actionType === 'view') {
                // PENDING & COMPLETED PROJECTS redirect to the view page
                targetPage = `view_submission.html?id=${projectId}`; 
            }
            
            if (targetPage) {
                window.location.href = targetPage;
            } else {
                alert("Navigation Error: Invalid action type.");
            }
        }

        // --- RENDER FUNCTIONS ---
        
        function renderStats(statusData) {
            const container = document.getElementById('stats-grid-container');
            const totalAssigned = ALL_PROJECTS_LIST.length;
            const reviewsCompleted = statusData.completed.length;
            const pendingReviews = statusData.pending.length;

            const stats = [
                { title: "Projects Assigned", value: totalAssigned, icon: "fas fa-list-ul", class: "accent-blue-card" },
                { title: "Pending Reviews", value: pendingReviews, icon: "fas fa-hourglass-start", class: "accent-orange-card" },
                { title: "Reviews Completed", value: reviewsCompleted, icon: "fas fa-check-double", class: "accent-green-card" },
                { title: "Avg. Score Given", value: JUDGE_DATA.avg_score, icon: "fas fa-tachometer-alt", class: "accent-purple-card" },
            ];

            let html = '';
            stats.forEach(stat => {
                html += `
                    <div class="stat-card ${stat.class}"> 
                        <div class="stat-icon"><i class="${stat.icon}"></i></div>
                        <div class="stat-info">
                            <h3>${stat.title}</h3>
                            <p class="stat-value">${stat.value}</p>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function renderProjectList(statusData) {
            const container = document.getElementById('project-list-container');
            let html = '';

            const projectsWithStatus = ALL_PROJECTS_LIST.map(project => {
                // STATUS CHECK: This logic determines the button text and status tag
                const status = statusData.completed.includes(project.id) ? 'completed' : 'pending';
                return { ...project, status };
            });

            // Sort pending projects first
            projectsWithStatus.sort((a, b) => (a.status === 'pending' ? -1 : 1));

            projectsWithStatus.forEach(project => {
                const isCompleted = project.status === 'completed';
                
                const itemClass = isCompleted ? 'project-item reviewed-item' : 'project-item';
                const statusClass = isCompleted ? 'review-status completed' : 'review-status pending';
                const statusText = isCompleted ? 'Reviewed' : 'Pending';
                
                let buttonHtml;
                if (isCompleted) {
                    // Completed Project: View Feedback button (Change detected here)
                    buttonHtml = `<button class="action-btn view-btn" onclick="handleAction('${project.id}', 'view')"><i class="fas fa-eye"></i> View Feedback</button>`;
                } else {
                    // Pending Project: Review & Rate button
                    buttonHtml = `<button class="action-btn rate-btn" onclick="handleAction('${project.id}', 'review')"><i class="fas fa-star"></i> Review & Rate</button>`;
                }

                html += `
                    <div class="${itemClass}" data-project-id="${project.id}">
                        <div class="project-info">
                            <span class="project-id">${project.id} | ${project.event}</span>
                            <span class="project-title">${project.title}</span>
                            <span class="team-name">${project.team}</span>
                        </div>
                        <span class="${statusClass}">${statusText}</span>
                        ${buttonHtml}
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // Initialize Dashboard
        document.addEventListener('DOMContentLoaded', () => {
            // NOTE: Removed the force-reset line. It is recommended to manually clear cache/LS if issues persist.
            
            const statusData = getJudgeStatusData(); // Get the persistent status (and recalculate pending)
            
            document.getElementById('judge-name').innerText = JUDGE_DATA.name.split(' ')[0];
            
            renderStats(statusData);
            renderProjectList(statusData);
        });
    </script>
</body>
</html>